
<html>
    <head>
        <script src='assets/lib/phaser/build/phaser.min.js'></script> 
    </head>

    <body>
        <script type='text/javascript'>
            //OMG Flocking http://www.emanueleferonato.com/2016/01/12/how-to-simulate-flocking-behavior-with-boids-using-html5-and-phaser/
            
            var game = new Phaser.Game(800, 600, Phaser.CANVAS, '', {preload: preload, create: create, update: update});
            var hero_state = { SQUARE:1, TRIANGLE:2, CIRCLE:3 };
            var hero_current;
            var player;
            var cursors;
            var field;
            var spacekey;
            var music;
            var text;
            var npcs;
            var fps;
            
            var cursorproxybody;
            var line;
            
            
            function preload(){
                game.time.advancedTiming = true;



                game.load.spritesheet("hero", "assets/images/sprites/hero.png", 32, 32);
            
                
                /*
                game.load.tilemap('tilemap1', 'assets/stages/test-world.json', null, Phaser.Tilemap.TILED_JSON);
                game.load.image('tileset1', 'assets/images/test-world.png');
                */
                
                
                game.load.tilemap('tilemap1', 'assets/stages/organic-tilemap.json', null, Phaser.Tilemap.TILED_JSON);
                game.load.image('tileset1', 'assets/images/organic-tileset.png');
                
                game.load.audio('music', 'assets/sound/background_music-02.wav');

            };

            function create(){
                /*global Phaser*/
                game.physics.startSystem(Phaser.Physics.P2JS);
                //game.world.setBounds(0,0,1600, 1200);

                map = game.add.tilemap('tilemap1', 32, 32);
                map.addTilesetImage('tileset1');
                layer = map.createLayer('layer1');
                layer.resizeWorld();
                
                music = game.add.audio('music');
                music.play();
                music.loopFull(0.6);
                
                map.setCollision(1, true);
                
                text = game.add.text(32, 32, 'Tiny Bags of Water you are made Of : ' + game.world.width + 'x' + game.world.height, {font: '15px Arial', fill: '#FFFFFF' });
                text.fixedToCamera=true;
                
                fps = game.add.text(32, 60, 'fps', {font: '15px Arial', fill: '#FFFFFF' });
                fps.fixedToCamera=true;
                
                player = game.add.sprite(game.world.width / 2, 200, 'hero', 0);
                hero_current = hero_state.SQUARE;
                player.animations.add('square', [0], 10, true);
                player.animations.add('triangle', [1], 10, true);
                player.animations.add('circle', [2], 10, true);

                //  We need to enable physics on the player
                game.physics.p2.enable(player);
                
                //  Player physics properties. Give the little guy a slight bounce.
                /*
                player.body.bounce.y = 0.5;
                player.body.bounce.x = 0.5;
                //player.body.gravity.y = -300;
                //player.body.gravity.x = -100;
                player.body.collideWorldBounds = true;

                player.body.maxVelocity.x = 200
                player.body.maxVelocity.y = 200
                player.body.drag.x = 50
                player.body.drag.y = 50
                */
                player.body.data_accel = 100;
                player.body.damping = 0.5;
                player.body.setCircle(20)
                game.camera.follow(player);
                
                
                // Alan experiment
                //cursorproxybody = game.add.sprite(player.body.position.x, player.body.position.y, 'cursor');
                
                
                cursors = game.input.keyboard.createCursorKeys();
                
                spacekey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
                game.input.keyboard.addKeyCapture([ Phaser.Keyboard.SPACEBAR ]);
                
                npcs = game.add.group();
                npcs.enableBody = true;
                npcs.physicsBodyType = Phaser.Physics.P2JS
                for (var i = 0; i < 200; i++) {
                    var npc =npcs.create(game.world.randomX, game.world.randomY, 'npc')
                    npc.body.setCircle(16)
                }
            };

            function update(){
                //player.body.setZeroVelocity();
                
                var velocityConstant=2;
                // Horizontal
                if (cursors.left.isDown) {
                    player.body.data.velocity[0]+=velocityConstant;
                } else if (cursors.right.isDown) {
            		player.body.data.velocity[0]-=velocityConstant;
                }
                
                // Vertical
                if (cursors.up.isDown) {
                	player.body.data.velocity[1]+=velocityConstant;
                } else if (cursors.down.isDown) {
                    player.body.data.velocity[1]-=velocityConstant;
                }
            
                /*
                // TODO: Define background field
                if (!game.camera.atLimit.x) {
                    field.tilePosition.x -= (player.body.velocity.x * game.time.physicsElapsed);
                }
            
                if (!game.camera.atLimit.y) {
                    field.tilePosition.y -= (player.body.velocity.y * game.time.physicsElapsed);
                }
                */
                
                if(spacekey.downDuration(5))
                {
                    switch(hero_current) {
                        case hero_state.SQUARE:
                            player.animations.play('triangle');
                            hero_current = hero_state.TRIANGLE;
                            break;
                        case hero_state.TRIANGLE:
                            player.animations.play('circle');
                            hero_current = hero_state.CIRCLE;
                            break;
                        case hero_state.CIRCLE:
                            player.animations.play('square');
                            hero_current = hero_state.SQUARE;
                            break;
                    }
                }
                /*
                for (var i=0; i < npcs.length; i++){
                    var npc = npcs[i]
                    var npc_velocity = 1
                    var npc_cur_x = npc.body.x
                    var npc_cur_y = npc.body.y
                    var player_cur_x = player.body.x
                    var player_cur_y = player.body.y
                    
                    var delta_x = player_cur_x - npc_cur_x
                    var delta_y = player_cur_y - npc_cur_y
                    
                    npc.body.data.velocity[0] = delta_x
                    npc.body.data.velocity[1] = delta_y
                    constrainVelocity(npc, 15)
                }
                */
                
                constrainVelocity(player, 20);
                fps.text = (game.time.fps || '--');
            };
            
            function constrainVelocity(sprite, maxVelocity) {
              var body = sprite.body
              var angle, currVelocitySqr, vx, vy;
            
              vx = body.data.velocity[0];
              vy = body.data.velocity[1];
              
              currVelocitySqr = vx * vx + vy * vy;
              
              if (currVelocitySqr > maxVelocity * maxVelocity) {
                angle = Math.atan2(vy, vx);
                
                vx = Math.cos(angle) * maxVelocity;
                vy = Math.sin(angle) * maxVelocity;
                
                body.data.velocity[0] = vx;
                body.data.velocity[1] = vy;
                console.log("Constrained velocity of " + player + " to vx=" + vx + " vy="+vy);
              }
                
            };

        </script>
    </body>
</html>
