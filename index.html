
<html>
    <head>
        <script src='assets/lib/phaser/build/phaser.min.js'></script> 
    </head>

    <body>
        <script type='text/javascript'>
            //OMG Flocking http://www.emanueleferonato.com/2016/01/12/how-to-simulate-flocking-behavior-with-boids-using-html5-and-phaser/
            
            var game = new Phaser.Game(800, 600, Phaser.CANVAS, '', {preload: preload, create: create, update: update});
            var hero_state = { SQUARE:1, TRIANGLE:2, CIRCLE:3 };
            var hero_current;
            var player;
            var cursors;
            var field;
            var spacekey;
            var music;
            var text;
            var npcs;
            var fps;
            var end_goal;
            
            var cursorproxybody;
            var line;
            
            var snakeHead;

            
            var playerCollisionGroup;
            var goalCollisionGroup;
            var enemyCollisionGroup;
            
            
            function preload(){
                game.time.advancedTiming = true;

                game.load.spritesheet("hero", "assets/images/sprites/hero.png", 32, 32);
                game.load.spritesheet('friendly_triangle', "assets/images/triangle-spritesheet.png", 32, 32);
                game.load.spritesheet('friendly_square', "assets/images/square-spritesheet.png", 32, 32);
                game.load.spritesheet('friendly_circle', "assets/images/circle-spritesheet.png", 32, 32);
                game.load.spritesheet('player_square_spritesheet', 'assets/images/player-square-spritesheet.png', 32, 32);
                game.load.spritesheet("goal", "assets/images/sprites/temp_goal.png", 32, 32);
                
                game.load.tilemap('tilemap1', 'assets/stages/organic-tilemap.json', null, Phaser.Tilemap.TILED_JSON);
                game.load.image('tileset1', 'assets/images/organic-tileset.png');
                game.load.image('background', 'assets/images/background.png');
                
                //game.load.audio('music', 'assets/sound/background_music.wav');

            };

            function create(){
                /*global Phaser*/
                game.physics.startSystem(Phaser.Physics.P2JS);

                tilesprite = game.add.tileSprite(0,0,3200,3200,'background');
                map = game.add.tilemap('tilemap1', 32, 32);
                map.addTilesetImage('tileset1');
                layer = map.createLayer('layer1');
                layer.resizeWorld();
                
                music = game.add.audio('music');
                //music.play();
                //music.loopFull(0.6);
                
                map.setCollision([0,1,2,3,4,25,26,27,28,29,50,51,52], true, 'layer1');
                game.physics.p2.convertTilemap(map, layer);
                
                text = game.add.text(32, 32, 'Tiny Bags of Water you are made Of : ' + game.world.width + 'x' + game.world.height, {font: '15px Arial', fill: '#FFFFFF' });
                text.fixedToCamera=true;
                
                fps = game.add.text(32, 60, 'fps', {font: '15px Arial', fill: '#FFFFFF' });
                fps.fixedToCamera=true;
                
                game.physics.p2.setImpactEvents(true)
                
                player = game.add.sprite(400, 200, 'player_square_spritesheet', 0);
                hero_current = hero_state.SQUARE;
                 
                player.animations.add('player_square_spritesheet', [0,0,0,0,0,0,0,0,1])
                /*
                player.animations.add('square', [0], 10, true);
                player.animations.add('triangle', [1], 10, true);
                player.animations.add('circle', [2], 10, true);
                */

                //  We need to enable physics on the player
                game.physics.p2.enable(player);
                
                player.body.data_accel = 100;
                player.body.damping = 0.5;
                player.body.setCircle(20)
                game.camera.follow(player);
                
                // Alan experiment
                //cursorproxybody = game.add.sprite(player.body.position.x, player.body.position.y, 'cursor');
                
                cursors = game.input.keyboard.createCursorKeys();
                
                spacekey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
                game.input.keyboard.addKeyCapture([ Phaser.Keyboard.SPACEBAR ]);
                
                npcs = game.add.group();
                npcs.enableBody = true;
                npcs.physicsBodyType = Phaser.Physics.P2JS
                for (var i = 0; i < 100; i++) {
                    /*
                        Friendly animations are frames 0-4.  Angry animations are frames 5-9.
                    */
                    
                    var rand = Math.random() * 3
                    if (rand >= 2) { // circle
                        var npc = npcs.create(game.world.randomX, game.world.randomY, 'friendly_circle');
                        npc.animations.add('friendly_circle', [0,0,0,1,2,3,4]);
                        npc.animations.play('friendly_circle', (Math.random() * 5), true);
                        npc.data_shape = "circle"
                    } else if (rand >= 1) { // triangle
                        var npc = npcs.create(game.world.randomX, game.world.randomY, 'friendly_triangle');
                        npc.animations.add('friendly_triangle', [0,0,0,1,2,3,4]);
                        npc.animations.play('friendly_triangle', (Math.random() * 5), true);
                        npc.data_shape = "triangle"
                    } else if (rand >= 0) { // square
                        var npc = npcs.create(game.world.randomX, game.world.randomY, 'friendly_square');
                        npc.animations.add('friendly_square', [0,0,0,1,2,3,4]);
                        npc.animations.play('friendly_square', (Math.random() * 5), true);
                        npc.data_shape = "square"
                    }
                    npc.body.setCircle(16);
                }
                
                snakeHead = npcs.create(400,400, 'snakehead');
                createSnake( snakeHead, 20 );
                game.physics.p2.enable(snakeHead);
                snakeHead.body.setCircle(16);
                //snakeHead.body.static = true;
                
                
                /*
                var triangleFrames = Phaser.animations.generateFrameNames('friendly_triangle')
                */
                // goal definition.
                end_goal = game.add.group();
                var goal = end_goal.create(game.world.width-50, game.world.height.height-50, 'goal');
                game.physics.p2.enable(goal);
                goal.body.immovable = true;
                goal.body.setCircle(10);

            };

            // Snake Experiment
            function createSnake(snakeHead, length) {
                console.log("Creating snake at " + snakeHead.body.x + "," + snakeHead.body.y);
                var lastitem = snakeHead;
                //snakeHead.body.mass = length;
                
                
                for(var i = 0; i < 10; i++) {
                    console.log("Creating snake segment " + i + " at " + snakeHead.body.x + "," + snakeHead.body.y);
                    var nextitem = game.add.sprite(snakeHead.body.x+(15*i), snakeHead.body.y+(15*i), 'snakebody');
                    game.physics.p2.enable(nextitem);
                    nextitem.body.setCircle(16);
                    nextitem.body.mass = length / i;
                    //game.physics.p2.createRevoluteConstraint(nextitem, [32,32], lastitem, [32,32], 20000);
                    //lastitem = nextitem;
                }
                
            }

            function update(){
                //player.body.setZeroVelocity();
                
                /*game.physics.p2.collide */
                var velocityConstant=2;
                // Horizontal
                if (cursors.left.isDown) {
                    player.body.data.velocity[0]+=velocityConstant;
                } else if (cursors.right.isDown) {
            		player.body.data.velocity[0]-=velocityConstant;
                }
                
                // Vertical
                if (cursors.up.isDown) {
                	player.body.data.velocity[1]+=velocityConstant;
                } else if (cursors.down.isDown) {
                    player.body.data.velocity[1]-=velocityConstant;
                }
            
                /*
                // TODO: Define background field
                if (!game.camera.atLimit.x) {
                    field.tilePosition.x -= (player.body.velocity.x * game.time.physicsElapsed);
                }
            
                if (!game.camera.atLimit.y) {
                    field.tilePosition.y -= (player.body.velocity.y * game.time.physicsElapsed);
                }
                */
                
                
                if(spacekey.downDuration(5))
                {
                    switch(hero_current) {
                        case hero_state.SQUARE:
                            player.animations.play('player_square_spritesheet', 5, true);
                            hero_current = hero_state.TRIANGLE;
                            break;
                        case hero_state.TRIANGLE:
                            player.animations.play('player_square_spritesheet', 5, true);
                            hero_current = hero_state.CIRCLE;
                            break;
                        case hero_state.CIRCLE:
                            player.animations.play('player_square_spritesheet', 5, true);
                            hero_current = hero_state.SQUARE;
                            break;
                    }
                }
                
                for (var i=0; i < npcs.children.length; i++){
                    var npc = npcs.children[i]
                    if (npc.inCamera) {
                        var npc_velocity = 1
                        var npc_cur_x = npc.body.x
                        var npc_cur_y = npc.body.y
                        var player_cur_x = player.body.x
                        var player_cur_y = player.body.y
                        
                        var delta_x = npc_cur_x - player_cur_x
                        var delta_y = npc_cur_y - player_cur_y
                        var magnitude = Math.sqrt(delta_x * delta_x + delta_y * delta_y)
                        
                        if (magnitude < 500) {
                            switch(hero_current) {
                            case hero_state.TRIANGLE:
                                if (npc.data_shape == 'triangle') {
                                    npc.body.data.velocity[0] = -delta_x
                                    npc.body.data.velocity[1] = -delta_y
                                } else {
                                    npc.body.data.velocity[0] = delta_x
                                    npc.body.data.velocity[1] = delta_y
                                }
                                break;
                            case hero_state.CIRCLE:
                                if (npc.data_shape == 'circle') {
                                    npc.body.data.velocity[0] = -delta_x
                                    npc.body.data.velocity[1] = -delta_y
                                } else {
                                    npc.body.data.velocity[0] = delta_x
                                    npc.body.data.velocity[1] = delta_y
                                }
                                break;
                            case hero_state.SQUARE:
                                if (npc.data_shape == 'square') {
                                    npc.body.data.velocity[0] = -delta_x
                                    npc.body.data.velocity[1] = -delta_y
                                } else {
                                    npc.body.data.velocity[0] = delta_x
                                    npc.body.data.velocity[1] = delta_y
                                }
                                break;
                            }
                            //npc.body.data.velocity[0] = delta_x
                            //npc.body.data.velocity[1] = delta_y
                            constrainVelocity(npc, 10)
                        }
                    }
                }
                
                
                constrainVelocity(player, 20);
                fps.text = (game.time.fps || '--');
            };
            
            function constrainVelocity(sprite, maxVelocity) {
              var body = sprite.body
              var angle, currVelocitySqr, vx, vy;
            
              vx = body.data.velocity[0];
              vy = body.data.velocity[1];
              
              currVelocitySqr = vx * vx + vy * vy;
              
              if (currVelocitySqr > maxVelocity * maxVelocity) {
                angle = Math.atan2(vy, vx);
                
                vx = Math.cos(angle) * maxVelocity;
                vy = Math.sin(angle) * maxVelocity;
                
                body.data.velocity[0] = vx;
                body.data.velocity[1] = vy;
              }
                
            };
            
            function playerHits(body1, body2) {
                text.text = 'Player hit something';
            };

        </script>
    </body>
</html>
